{"version":3,"sources":["file:///Users/sunjia/project/cocos-test/cocos-demo/extensions/live2d_cubismsdk_cocoscreator/static/assets/Framework/Pose/CubismPoseController.ts"],"names":["CCInteger","Component","_decorator","ComponentExtensionMethods4Core","ComponentExtensionMethods","CubismPosePart","CubismPart","CubismUpdateController","CubismUpdateExecutionOrder","ArrayExtensionMethods","ICubismUpdatable","CubismPoseData","ccclass","property","BACK_OPACITY_THRESHOLD","CubismPoseController","type","visible","SYMBOL","_model","_poseData","Array","bindedOnLateUpdate","onLateUpdate","bind","hasUpdateController","_hasUpdateController","value","refresh","findCubismModel","parts","console","assert","tags","getComponentsMany","i","length","groupIndex","partIndex","start","fill","arr","data","copyWith","posePart","part","getComponent","defaultPoseIndex","opacity","link","linkParts","j","linkId","findByIdFromParts","doFade","appearPartsGroupIndex","appearPartsGroupOpacity","delayedOpacity","backOpacity","copyPartOpacities","linkIndex","linkPart","savePartOpacities","executionOrder","CUBISM_POSE_CONTROLLER","needsUpdateOnEditing","enabled","onEnable","lateUpdate"],"mappings":"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","sourcesContent":["/**\r\n * Copyright(c) Live2D Inc. All rights reserved.\r\n *\r\n * Use of this source code is governed by the Live2D Open Software license\r\n * that can be found at https://www.live2d.com/eula/live2d-open-software-license-agreement_en.html.\r\n */\r\n\r\nimport { CCInteger, Component, _decorator } from 'cc';\r\nimport ComponentExtensionMethods4Core from '../../Core/ComponentExtensionMethods';\r\nimport ComponentExtensionMethods from '../ComponentExtensionMethods';\r\nimport CubismPosePart from './CubismPosePart';\r\nimport CubismPart from '../../Core/CubismPart';\r\nimport CubismUpdateController from '../CubismUpdateController';\r\nimport CubismUpdateExecutionOrder from '../CubismUpdateExecutionOrder';\r\nimport ArrayExtensionMethods from '../../Core/ArrayExtensionMethods';\r\nimport ICubismUpdatable from '../ICubismUpdatable';\r\nimport CubismPoseData from './CubismPoseData';\r\nimport type CubismModel from '../../Core/CubismModel';\r\nconst { ccclass, property } = _decorator;\r\n\r\n/**\r\n * Back opacity threshold.\r\n */\r\nconst BACK_OPACITY_THRESHOLD = 0.15;\r\n\r\n/**\r\n * Cubism pose controller.\r\n *\r\n * **Sealed class**\r\n */\r\n@ccclass('CubismPoseController')\r\nexport default class CubismPoseController extends Component implements ICubismUpdatable {\r\n  //#region variable\r\n\r\n  /** Default visible pose index. */\r\n  @property({ type: CCInteger })\r\n  public defaultPoseIndex: number = 0;\r\n\r\n  /** Cubism model cache. */\r\n  private _model: CubismModel | null = null;\r\n\r\n  @property({ visible: false })\r\n  private _hasUpdateController: boolean = false;\r\n\r\n  /** Model has update controller component. */\r\n  @property({ visible: false })\r\n  public get hasUpdateController(): boolean {\r\n    return this._hasUpdateController;\r\n  }\r\n  public set hasUpdateController(value: boolean) {\r\n    this._hasUpdateController = value;\r\n  }\r\n\r\n  /** Pose data. */\r\n  private _poseData: CubismPoseData[][] = new Array(0);\r\n\r\n  //#endregion\r\n\r\n  //#region Function\r\n\r\n  /** update hidden part opacity. */\r\n  public refresh(): void {\r\n    this._model = ComponentExtensionMethods4Core.findCubismModel(this);\r\n\r\n    // Fail silently...\r\n    if (this._model == null) {\r\n      return;\r\n    }\r\n\r\n    const { parts } = this._model;\r\n    if (parts == null) {\r\n      console.assert(parts);\r\n      return;\r\n    }\r\n\r\n    const tags = ComponentExtensionMethods.getComponentsMany(parts, CubismPosePart);\r\n    for (let i = 0; i < tags.length; i++) {\r\n      const groupIndex = tags[i].groupIndex;\r\n      const partIndex = tags[i].partIndex;\r\n\r\n      if (this._poseData == null) {\r\n        this._poseData = new Array(1);\r\n        this._poseData[0] = new Array(0);\r\n      } else if (this._poseData.length <= groupIndex) {\r\n        const start = this._poseData.length;\r\n        this._poseData.length = groupIndex + 1;\r\n        this._poseData.fill(new Array(0), start, groupIndex + 1);\r\n      }\r\n      const arr = this._poseData[groupIndex];\r\n      if (arr.length <= partIndex) {\r\n        const start = arr.length;\r\n        arr.length = partIndex + 1;\r\n        arr.fill(new CubismPoseData(), start, partIndex + 1);\r\n      }\r\n\r\n      let data = arr[partIndex];\r\n      data = data.copyWith({ posePart: tags[i], part: tags[i].getComponent(CubismPart) });\r\n      arr[partIndex] = data;\r\n\r\n      this.defaultPoseIndex = this.defaultPoseIndex < 0 ? 0 : this.defaultPoseIndex;\r\n      if (partIndex != this.defaultPoseIndex) {\r\n        const { part } = data;\r\n        if (part == null) {\r\n          console.assert(part);\r\n          continue;\r\n        }\r\n        part.opacity = 0.0;\r\n      }\r\n\r\n      console.assert(data.part);\r\n      data = data.copyWith({ opacity: data.part?.opacity });\r\n      arr[partIndex] = data;\r\n\r\n      if (tags[i].link == null || tags[i].link.length == 0) {\r\n        continue;\r\n      }\r\n\r\n      const linkParts = new Array<CubismPart | null>(tags[i].link.length);\r\n      for (let j = 0; j < tags[i].link.length; j++) {\r\n        let linkId = tags[i].link[j];\r\n        const part = ArrayExtensionMethods.findByIdFromParts(parts, linkId);\r\n        linkParts[j] = part;\r\n      }\r\n      data = data.copyWith({ linkParts: linkParts });\r\n      arr[partIndex] = data;\r\n    }\r\n\r\n    // Get cubism update controller.\r\n    this.hasUpdateController = this.getComponent(CubismUpdateController) != null;\r\n  }\r\n\r\n  /** update hidden part opacity. */\r\n  private doFade(): void {\r\n    for (let groupIndex = 0; groupIndex < this._poseData.length; groupIndex++) {\r\n      let appearPartsGroupIndex = -1;\r\n      let appearPartsGroupOpacity = 1.0;\r\n\r\n      // Find appear parts group index and opacity.\r\n      const arr = this._poseData[groupIndex];\r\n      for (let i = 0; i < arr.length; i++) {\r\n        const { part } = arr[i];\r\n        if (!part) {\r\n          console.assert(part);\r\n          continue;\r\n        }\r\n        if (part.opacity > arr[i].opacity) {\r\n          appearPartsGroupIndex = i;\r\n          appearPartsGroupOpacity = part.opacity;\r\n          break;\r\n        }\r\n      }\r\n\r\n      // Fail silently...\r\n      if (appearPartsGroupIndex < 0) {\r\n        return;\r\n      }\r\n\r\n      // Delay disappearing parts groups disappear.\r\n      for (let i = 0; i < arr.length; i++) {\r\n        // Fail silently...\r\n        if (i == appearPartsGroupIndex) {\r\n          continue;\r\n        }\r\n\r\n        const { part } = arr[i];\r\n        if (!part) {\r\n          console.assert(part);\r\n          continue;\r\n        }\r\n        let delayedOpacity = part.opacity;\r\n        const backOpacity = (1.0 - delayedOpacity) * (1.0 - appearPartsGroupOpacity);\r\n\r\n        // When restricting the visible proportion of the background\r\n        if (backOpacity > BACK_OPACITY_THRESHOLD) {\r\n          delayedOpacity = 1.0 - BACK_OPACITY_THRESHOLD / (1.0 - appearPartsGroupOpacity);\r\n        }\r\n\r\n        // Overwrite the opacity if it's greater than the delayed opacity.\r\n        if (part.opacity > delayedOpacity) {\r\n          part.opacity = delayedOpacity;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /** Copy opacity to linked parts. */\r\n  private copyPartOpacities(): void {\r\n    for (let groupIndex = 0; groupIndex < this._poseData.length; groupIndex++) {\r\n      const arr = this._poseData[groupIndex];\r\n      for (let partIndex = 0; partIndex < arr.length; partIndex++) {\r\n        const { linkParts, part } = arr[partIndex];\r\n        if (!linkParts.length) {\r\n          continue;\r\n        }\r\n        if (!part) {\r\n          console.assert(part);\r\n          continue;\r\n        }\r\n        const opacity = part.opacity;\r\n\r\n        for (let linkIndex = 0; linkIndex < linkParts.length; linkIndex++) {\r\n          const linkPart = linkParts[linkIndex];\r\n          if (linkPart) {\r\n            linkPart.opacity = opacity;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /** Save parts opacity. */\r\n  private savePartOpacities(): void {\r\n    for (let groupIndex = 0; groupIndex < this._poseData.length; groupIndex++) {\r\n      const arr = this._poseData[groupIndex];\r\n      for (let partIndex = 0; partIndex < arr.length; partIndex++) {\r\n        let data = arr[partIndex];\r\n        const { part } = data;\r\n        console.assert(part);\r\n        data.copyWith({ opacity: part?.opacity });\r\n      }\r\n    }\r\n  }\r\n\r\n  /** Called by cubism update controller. Order to invoke OnLateUpdate. */\r\n  public get executionOrder(): number {\r\n    return CubismUpdateExecutionOrder.CUBISM_POSE_CONTROLLER;\r\n  }\r\n\r\n  /** Called by cubism update controller. Needs to invoke OnLateUpdate on Editing. */\r\n  public get needsUpdateOnEditing() {\r\n    return false;\r\n  }\r\n\r\n  /** Called by cubism update manager. Updates controller. */\r\n  public onLateUpdate(): void {\r\n    // Fail silently...\r\n    if (!this.enabled || this._model == null || this._poseData == null) {\r\n      return;\r\n    }\r\n\r\n    this.doFade();\r\n    this.copyPartOpacities();\r\n    this.savePartOpacities();\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Cocos Creator Event Handling\r\n\r\n  /** Called by Cocos Creator. Makes sure cache is initialized. */\r\n  protected onEnable(): void {\r\n    this.refresh();\r\n  }\r\n\r\n  /** Called by Cocos Creator. */\r\n  protected lateUpdate(): void {\r\n    if (!this.hasUpdateController) {\r\n      this.onLateUpdate();\r\n    }\r\n  }\r\n\r\n  //#endregion\r\n\r\n  /** ICubismUpdatable Binded callback function. */\r\n  public bindedOnLateUpdate: ICubismUpdatable.CallbackFunction = this.onLateUpdate.bind(this);\r\n  /** ICubismUpdatable metadata */\r\n  public readonly [ICubismUpdatable.SYMBOL]: typeof ICubismUpdatable.SYMBOL =\r\n    ICubismUpdatable.SYMBOL;\r\n}\r\n"]}