{"version":3,"sources":["file:///Users/sunjia/project/cocos-test/cocos-demo/extensions/live2d_cubismsdk_cocoscreator/static/assets/Framework/CubismParameterStore.ts"],"names":["Component","_decorator","ComponentExtensionMethods","CubismUpdateController","CubismUpdateExecutionOrder","ICubismUpdatable","ccclass","property","CubismParameterStore","serializable","visible","SYMBOL","_destinationParameters","_destinationParts","_parameterValues","_partOpacities","bindedOnLateUpdate","onLateUpdate","bind","destinationParameters","value","destinationParts","hasUpdateController","_hasUpdateController","executionOrder","CUBISM_PARAMETER_STORE_SAVE_PARAMETERS","needsUpdateOnEditing","refresh","findCubismModel","parameters","parts","getComponent","saveParameters","deltaTime","enabled","Array","length","i","opacity","restoreParameters","onEnable"],"mappings":"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","sourcesContent":["/**\r\n * Copyright(c) Live2D Inc. All rights reserved.\r\n *\r\n * Use of this source code is governed by the Live2D Open Software license\r\n * that can be found at https://www.live2d.com/eula/live2d-open-software-license-agreement_en.html.\r\n */\r\n\r\nimport { Component, _decorator } from 'cc';\r\nimport ComponentExtensionMethods from '../Core/ComponentExtensionMethods';\r\nimport CubismUpdateController from './CubismUpdateController';\r\nimport CubismUpdateExecutionOrder from './CubismUpdateExecutionOrder';\r\nimport ICubismUpdatable from './ICubismUpdatable';\r\nimport type CubismParameter from '../Core/CubismParameter';\r\nimport type CubismPart from '../Core/CubismPart';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('CubismParameterStore')\r\nexport default class CubismParameterStore extends Component implements ICubismUpdatable {\r\n  private _destinationParameters: CubismParameter[] | null = null;\r\n  public get destinationParameters() {\r\n    return this._destinationParameters;\r\n  }\r\n  public set destinationParameters(value: CubismParameter[] | null) {\r\n    this._destinationParameters = value;\r\n  }\r\n\r\n  private _destinationParts: CubismPart[] | null = null;\r\n  public get destinationParts() {\r\n    return this._destinationParts;\r\n  }\r\n  public set destinationParts(value: CubismPart[] | null) {\r\n    this._destinationParts = value;\r\n  }\r\n\r\n  private _parameterValues: number[] | null = null;\r\n\r\n  private _partOpacities: number[] | null = null;\r\n\r\n  @property({ serializable: false, visible: false })\r\n  private _hasUpdateController: boolean = false;\r\n  public get hasUpdateController() {\r\n    return this._hasUpdateController;\r\n  }\r\n  public set hasUpdateController(value: boolean) {\r\n    this._hasUpdateController = value;\r\n  }\r\n\r\n  public get executionOrder(): number {\r\n    return CubismUpdateExecutionOrder.CUBISM_PARAMETER_STORE_SAVE_PARAMETERS;\r\n  }\r\n\r\n  public get needsUpdateOnEditing(): boolean {\r\n    return false;\r\n  }\r\n\r\n  public refresh() {\r\n    if (this.destinationParameters == null) {\r\n      this.destinationParameters =\r\n        ComponentExtensionMethods.findCubismModel(this)?.parameters ?? null;\r\n    }\r\n\r\n    if (this.destinationParts == null) {\r\n      this.destinationParts = ComponentExtensionMethods.findCubismModel(this)?.parts ?? null;\r\n    }\r\n\r\n    // Get cubism update controller.\r\n    this.hasUpdateController = this.getComponent(CubismUpdateController) != null;\r\n\r\n    this.saveParameters();\r\n  }\r\n\r\n  protected onLateUpdate(deltaTime: number) {\r\n    if (!this.hasUpdateController) {\r\n      return;\r\n    }\r\n\r\n    this.saveParameters();\r\n  }\r\n\r\n  /** ICubismUpdatable Binded callback function. */\r\n  public readonly bindedOnLateUpdate: ICubismUpdatable.CallbackFunction =\r\n    this.onLateUpdate.bind(this);\r\n  /** ICubismUpdatable metadata */\r\n  public readonly [ICubismUpdatable.SYMBOL]: typeof ICubismUpdatable.SYMBOL =\r\n    ICubismUpdatable.SYMBOL;\r\n\r\n  public saveParameters() {\r\n    // Fail silently...\r\n    if (!this.enabled) {\r\n      return;\r\n    }\r\n\r\n    // save parameters value\r\n    if (this.destinationParameters != null && this._parameterValues == null) {\r\n      this._parameterValues = new Array<number>(this.destinationParameters.length);\r\n    }\r\n\r\n    if (this._parameterValues != null && this.destinationParameters != null) {\r\n      for (let i = 0; i < this._parameterValues.length; ++i) {\r\n        if (this.destinationParameters[i] != null) {\r\n          this._parameterValues[i] = this.destinationParameters[i].value;\r\n        }\r\n      }\r\n    }\r\n\r\n    // save parts opacity\r\n    if (this.destinationParts != null && this._partOpacities == null) {\r\n      this._partOpacities = new Array(this.destinationParts.length);\r\n    }\r\n\r\n    if (this._partOpacities != null && this.destinationParts != null) {\r\n      for (let i = 0; i < this._partOpacities.length; ++i) {\r\n        this._partOpacities[i] = this.destinationParts[i].opacity;\r\n      }\r\n    }\r\n  }\r\n\r\n  public restoreParameters() {\r\n    // Fail silently...\r\n    if (!this.enabled) {\r\n      return;\r\n    }\r\n\r\n    // restore parameters value\r\n    if (this._parameterValues != null && this.destinationParameters != null) {\r\n      for (let i = 0; i < this._parameterValues.length; ++i) {\r\n        this.destinationParameters[i].value = this._parameterValues[i];\r\n      }\r\n    }\r\n\r\n    // restore parts opacity\r\n    if (this._partOpacities != null && this.destinationParts != null) {\r\n      for (let i = 0; i < this._partOpacities.length; ++i) {\r\n        this.destinationParts[i].opacity = this._partOpacities[i];\r\n      }\r\n    }\r\n  }\r\n\r\n  onEnable() {\r\n    // Initialize cache.\r\n    this.refresh();\r\n  }\r\n}\r\n"]}